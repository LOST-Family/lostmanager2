From 5e7129db310504ffca18e7357964d6782cc9cdc9 Mon Sep 17 00:00:00 2001
From: Alfred <alfred@openclaw.local>
Date: Thu, 5 Feb 2026 00:10:40 +0000
Subject: [PATCH] fix: Cache ImageMap per request to reduce HTTP calls

- Fetch image_map.json once per stats display instead of per comparison
- Reduces 60-100 HTTP requests to 1 per request
- Add ImageMapCache.fetchFullMapOnce() for per-request caching
- Use getInt() instead of optInt() for proper int parsing from JSON
- Memory-safe: cache is request-scoped, not static
---
 .../commands/coc/util/jsonutils/stats.java    | 23 +++++++++++++++----
 .../java/lostmanager/util/ImageMapCache.java  |  9 ++++++++
 2 files changed, 28 insertions(+), 4 deletions(-)

diff --git a/src/main/java/lostmanager/commands/coc/util/jsonutils/stats.java b/src/main/java/lostmanager/commands/coc/util/jsonutils/stats.java
index 180f85f..70d2f50 100644
--- a/src/main/java/lostmanager/commands/coc/util/jsonutils/stats.java
+++ b/src/main/java/lostmanager/commands/coc/util/jsonutils/stats.java
@@ -592,6 +592,15 @@ public class stats extends ListenerAdapter {
 	 * Format grouped data by data ID
 	 */
 	private String formatGroupedData(JSONArray arr, java.sql.Timestamp jsonTimestamp) {
+		// Fetch image map once for this request to avoid multiple HTTP calls during sorting
+		org.json.JSONObject imageMapCache = null;
+		try {
+			imageMapCache = lostmanager.util.ImageMapCache.fetchFullMapOnce();
+		} catch (Exception e) {
+			System.err.println("Failed to fetch image map for sorting: " + e.getMessage());
+		}
+		final org.json.JSONObject finalImageMapCache = imageMapCache;
+		
 		// Group objects by their data ID
 		Map<String, List<JSONObject>> groupedByData = new LinkedHashMap<>();
 
@@ -617,10 +626,16 @@ public class stats extends ListenerAdapter {
 		List<Map.Entry<String, List<JSONObject>>> entryList = new ArrayList<>(groupedByData.entrySet());
 		entryList.sort((e1, e2) -> {
 			try {
-				JSONObject d1 = lostmanager.util.ImageMapCache.getItemData(e1.getKey());
-				JSONObject d2 = lostmanager.util.ImageMapCache.getItemData(e2.getKey());
-				int i1 = d1 != null && d1.has("index") ? d1.optInt("index", Integer.MAX_VALUE) : Integer.MAX_VALUE;
-				int i2 = d2 != null && d2.has("index") ? d2.optInt("index", Integer.MAX_VALUE) : Integer.MAX_VALUE;
+				// Use cached image map to avoid HTTP requests per comparison
+				JSONObject d1 = null;
+				JSONObject d2 = null;
+				if (finalImageMapCache != null) {
+					d1 = finalImageMapCache.has(e1.getKey()) ? finalImageMapCache.getJSONObject(e1.getKey()) : null;
+					d2 = finalImageMapCache.has(e2.getKey()) ? finalImageMapCache.getJSONObject(e2.getKey()) : null;
+				}
+				
+				int i1 = d1 != null && d1.has("index") ? d1.getInt("index") : Integer.MAX_VALUE;
+				int i2 = d2 != null && d2.has("index") ? d2.getInt("index") : Integer.MAX_VALUE;
 				if (i1 != i2)
 					return Integer.compare(i1, i2);
 			} catch (Exception ex) {
diff --git a/src/main/java/lostmanager/util/ImageMapCache.java b/src/main/java/lostmanager/util/ImageMapCache.java
index 091f3d3..169aee5 100644
--- a/src/main/java/lostmanager/util/ImageMapCache.java
+++ b/src/main/java/lostmanager/util/ImageMapCache.java
@@ -52,6 +52,15 @@ public class ImageMapCache {
     }
   }
   
+  /**
+   * Fetch the full image map once per request
+   * Exposed for per-request caching to avoid multiple HTTP calls
+   * @return JSONObject containing the full image map or null if fetch fails
+   */
+  public static JSONObject fetchFullMapOnce() {
+    return fetchFullMap();
+  }
+  
   /**
    * Get item data by data ID
    * @param dataId The data ID to lookup
-- 
2.43.0

